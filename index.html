<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Formulario de Pedido</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/es.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #fff; }
    form { max-width: 600px; margin: auto; background: #f9f9f9; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0, 0, 0, 0.05); }
    label { font-weight: bold; display: block; margin: 10px 0 5px; }
    input, select, textarea { width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 5px; font-size: 16px; }
    input[type="checkbox"] { width: auto; margin-right: 10px; }
    input[type="submit"] { background: #f45b00; color: white; border: none; padding: 15px; border-radius: 50px; font-weight: bold; cursor: pointer; transition: background 0.3s; width: 100%; }
    input[type="submit"]:hover { background: #cc4800; }
    #mensaje { display: none; text-align: center; font-size: 20px; color: green; margin-top: 40px; }
    .check-icon { font-size: 50px; }
    #avisoPueblo, #avisoFecha { color: red; font-weight: bold; display: none; }
  </style>
</head>
<body>
  <form id="pedidoForm">
    <h2>Haz tu pedido de gasoil</h2>
    <label for="zona">Zona de reparto:</label>
    <select id="zona" required>
      <option value="">Seleccione una zona</option>
      <option value="sierraNorte">Sierra Norte</option>
      <option value="sierraOeste">Sierra Oeste</option>
    </select>

    <label for="pueblo">Pueblo:</label>
    <input list="listaPueblos" id="pueblo" required />
    <datalist id="listaPueblos"></datalist>
    <div id="avisoPueblo"></div>

    <label for="fecha">Fecha de preferencia:</label>
    <input type="text" id="fecha" required />
    <div id="avisoFecha"></div>

    <label for="direccion">Dirección:</label>
    <input type="text" id="direccion" required />

    <label for="cantidad">Cantidad (mínimo 300 litros):</label>
    <input type="number" id="cantidad" min="300" required />

    <label for="nombre">Nombre:</label>
    <input type="text" id="nombre" required />

    <label for="telefono">Teléfono:</label>
    <input type="tel" id="telefono" required />

    <label for="email">Correo electrónico:</label>
    <input type="email" id="email" required />

    <label for="observaciones">Observaciones:</label>
    <textarea id="observaciones" rows="4"></textarea>

    <label>
      <input type="checkbox" id="consentimiento" required />
      Acepto los términos y condiciones y la política de privacidad.
    </label>

    <input type="submit" value="Enviar Pedido" />
  </form>

  <div id="mensaje">
    <div class="check-icon">✅</div>
    <p>Pedido enviado correctamente.<br><strong>Gracias por confiar en Grupo Geslama.</strong></p>
  </div>

  <script>
    const pueblosPorZona = {
      sierraNorte: ["Berrueco", "Bustarviejo", "Cabanillas de la Sierra", "El Molar", "Guadalix de la Sierra", "La Cabrera", "Lozoyuela", "Pedrezuela", "San Agustín del Guadalix", "Venturada"],
      sierraOeste: ["Aldea del Fresno", "Cebreros", "Chapinería", "Colmenar del Arroyo", "El Tiemblo", "Fresnedillas de la Oliva", "Navalagamella", "Navas del Rey", "Pelayos de la Presa", "Quijorna", "Robledo de Chavela", "San Martín de Valdeiglesias", "Villamanta", "Villamantilla", "Villanueva de Perales"]
    };

    let fechasNoDisponibles = {};
    let calendarioIniciado = false;

    const jsonUrl = "https://script.google.com/macros/s/AKfycbzXa3o-lKsHqhRZBUZUe9bTPCh0U9X_85JAlafPQEpeUsOrvzuUWvdAhtiKFETbxz_H/exec";

    fetch(jsonUrl)
      .then(res => res.json())
      .then(data => { fechasNoDisponibles = data; })
      .catch(err => console.error("Error al cargar JSON:", err));

    document.getElementById("zona").addEventListener("change", () => {
      const zona = document.getElementById("zona").value;
      const lista = document.getElementById("listaPueblos");
      lista.innerHTML = "";
      if (pueblosPorZona[zona]) {
        pueblosPorZona[zona].forEach(p => {
          const option = document.createElement("option");
          option.value = p;
          lista.appendChild(option);
        });
      }
    });

    document.getElementById("pueblo").addEventListener("input", () => {
      const pueblo = document.getElementById("pueblo").value.trim();
      const aviso = document.getElementById("avisoPueblo");

      // Calcular días disponibles
      let conteo = { "Lunes": 0, "Martes": 0, "Miércoles": 0, "Jueves": 0, "Viernes": 0, "Sábado": 0 };
      for (const fecha in fechasNoDisponibles) {
        const fechaObj = new Date(fecha);
        const diaSemana = fechaObj.toLocaleDateString('es-ES', { weekday: 'long' });
        if (!(fechasNoDisponibles[fecha][pueblo] === "NO")) {
          if (conteo[diaSemana] !== undefined) conteo[diaSemana]++;
        }
      }

      const diasPermitidos = Object.entries(conteo).filter(([dia, val]) => val > 0).length;

      if (diasPermitidos < 5) {
  const ordenDias = ["Lunes", "Martes", "Miércoles", "Jueves", "Viernes", "Sábado"];
  const diasDisponibles = ordenDias.filter(d => conteo[d] > 0);
  aviso.style.display = "block";
  aviso.textContent = `Este pueblo se reparte ${diasDisponibles.join(", ")}.`;
} else {
  aviso.style.display = "none";
}


      if (!calendarioIniciado && Object.keys(fechasNoDisponibles).length > 0) {
        flatpickr("#fecha", {
          dateFormat: "Y-m-d",
          minDate: new Date().fp_incr(1),
          locale: "es",
          disable: [
            function (date) {
              const fechaStr = date.toISOString().split("T")[0];
              if (!fechasNoDisponibles[fechaStr]) return false;
              if (fechasNoDisponibles[fechaStr][pueblo] === "NO") return true;
              return false;
            }
          ]
        });
        calendarioIniciado = true;
      }
    });

    document.getElementById("fecha").addEventListener("change", () => {
      const fecha = document.getElementById("fecha").value;
      const pueblo = document.getElementById("pueblo").value.trim();
      const aviso = document.getElementById("avisoFecha");
      if (fechasNoDisponibles[fecha] && fechasNoDisponibles[fecha][pueblo] === "NO") {
        aviso.style.display = "block";
        aviso.textContent = "Lo sentimos, no hay reparto disponible en esa fecha.";
      } else {
        aviso.style.display = "none";
      }
    });

    document.getElementById("pedidoForm").addEventListener("submit", (e) => {
      const fecha = document.getElementById("fecha").value;
      const pueblo = document.getElementById("pueblo").value.trim();
      if (fechasNoDisponibles[fecha] && fechasNoDisponibles[fecha][pueblo] === "NO") {
        e.preventDefault();
        document.getElementById("avisoFecha").style.display = "block";
        document.getElementById("avisoFecha").textContent = "Lo sentimos, no hay reparto disponible en esa fecha.";
        return;
      }

      e.preventDefault();

      const datos = {
        fecha: fecha,
        zona: document.getElementById("zona").value,
        pueblo: pueblo,
        direccion: document.getElementById("direccion").value,
        cantidad: document.getElementById("cantidad").value,
        nombre: document.getElementById("nombre").value,
        telefono: document.getElementById("telefono").value,
        email: document.getElementById("email").value,
        observaciones: document.getElementById("observaciones").value,
        consentimiento: document.getElementById("consentimiento").checked ? "Sí" : "No"
      };

      const formData = new FormData();
      for (const key in datos) formData.append(key, datos[key]);

      fetch("https://script.google.com/macros/s/AKfycbxhTezL0HmZyd13o73LgqGdSksZowg34n1_ZNtuLAaEU4qTB3QPskM6HCTdesg6gZmDxw/exec", {
        method: "POST",
        mode: "no-cors",
        body: formData
      });

      document.getElementById("pedidoForm").style.display = "none";
      document.getElementById("mensaje").style.display = "block";
    });
  </script>
</body>
</html>
