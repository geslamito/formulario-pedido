<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Formulario de Pedido</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/es.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background: #fff; padding: 20px; }
    form {
      max-width: 600px;
      margin: auto;
      background: #f9f9f9;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.05);
    }
    input, select, textarea {
      width: 100%; padding: 12px; margin-bottom: 15px;
      border-radius: 5px; border: 1px solid #ccc; font-size: 16px;
    }
    input[type="checkbox"] { width: auto; margin-right: 10px; }
    input[type="submit"] {
      background-color: #f45b00; color: white; border: none;
      padding: 15px 30px; font-weight: bold; text-transform: uppercase;
      border-radius: 50px; cursor: pointer; transition: 0.3s;
    }
    input[type="submit"]:hover { background-color: #cc4800; }
    #mensaje {
      display: none; text-align: center; margin-top: 40px;
      font-size: 20px; color: green;
    }
    .check-icon { font-size: 50px; color: green; }
  </style>
</head>
<body>

<form id="pedidoForm">
  <h2>Haz tu pedido de gasoil</h2>

  <label for="zona">Zona de reparto:</label>
  <select id="zona" name="zona" onchange="showPueblos();" required>
    <option value="">Seleccione una zona</option>
    <option value="sierraNorte">Sierra Norte</option>
    <option value="sierraOeste">Sierra Oeste</option>
  </select>

  <label for="pueblo">Pueblo:</label>
  <input list="listaPueblos" id="pueblo" name="pueblo" required />
  <datalist id="listaPueblos"></datalist>

  <div id="avisoPueblo" style="color: red; font-weight: bold; display: none;"></div>

  <label for="fecha">Fecha de preferencia:</label>
  <input type="text" id="fecha" name="fecha" required />
  <div id="avisoFecha" style="color: red; font-weight: bold; display: none; margin-bottom: 15px;"></div>

  <label for="direccion">Dirección:</label>
  <input type="text" id="direccion" name="direccion" required />

  <label for="cantidad">Cantidad (mínimo 300 litros):</label>
  <input type="number" id="cantidad" name="cantidad" min="300" required />

  <label for="nombre">Nombre:</label>
  <input type="text" id="nombre" name="nombre" required />

  <label for="telefono">Teléfono:</label>
  <input type="tel" id="telefono" name="telefono" required />

  <label for="email">Correo electrónico:</label>
  <input type="email" id="email" name="email" required />

  <label for="observaciones">Observaciones:</label>
  <textarea id="observaciones" name="observaciones" rows="4"></textarea>

  <label>
    <input type="checkbox" id="consentimiento" name="consentimiento" required />
    Acepto los términos y condiciones y la política de privacidad.
  </label>

  <input type="submit" value="Enviar Pedido" />
</form>

<div id="mensaje">
  <div class="check-icon">✅</div>
  <div>Pedido enviado correctamente.<br><strong>Gracias por confiar en Grupo Geslama.</strong></div>
</div>

<script>
  const pueblosPorZona = {
    sierraNorte: ["Berrueco", "Bustarviejo", "Cabanillas de la Sierra", "El Molar", "Guadalix de la Sierra", "La Cabrera", "Lozoyuela", "Pedrezuela", "San Agustín del Guadalix", "Venturada"],
    sierraOeste: ["Aldea del Fresno", "Cebreros", "Chapinería", "Colmenar del Arroyo", "El Tiemblo", "Fresnedillas de la Oliva", "Navalagamella", "Navas del Rey", "Pelayos de la Presa", "Quijorna", "Robledo de Chavela", "San Martín de Valdeiglesias", "Villamanta", "Villamantilla", "Villanueva de Perales"]
  };

  const jsonUrl = "https://script.google.com/macros/s/AKfycbzXa3o-lKsHqhRZBUZUe9bTPCh0U9X_85JAlafPQEpeUsOrvzuUWvdAhtiKFETbxz_H/exec";
  let fechasNoDisponibles = {};
  let calendarioIniciado = false;

  function limpiarTexto(texto) {
    return texto.normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/\./g, "").trim().toLowerCase();
  }

  fetch(jsonUrl)
    .then(res => res.json())
    .then(data => {
      fechasNoDisponibles = data;
    })
    .catch(err => console.error("Error cargando fechas:", err));

  function showPueblos() {
    const zona = document.getElementById("zona").value;
    const lista = document.getElementById("listaPueblos");
    lista.innerHTML = "";
    if (pueblosPorZona[zona]) {
      pueblosPorZona[zona].forEach(p => {
        const option = document.createElement("option");
        option.value = p;
        lista.appendChild(option);
      });
    }
    document.getElementById("pueblo").value = "";
    calendarioIniciado = false;
  }

  function inicializarCalendario() {
    if (calendarioIniciado) return;
    flatpickr("#fecha", {
      dateFormat: "Y-m-d",
      minDate: "today",
      locale: "es",
      disable: [
        function(date) {
          const fechaStr = date.toISOString().split("T")[0];
          const pueblo = limpiarTexto(document.getElementById("pueblo").value);
          const bloqueos = fechasNoDisponibles[fechaStr];
          if (!bloqueos) return false;
          const clavesNormalizadas = Object.keys(bloqueos).map(k => limpiarTexto(k));
          const index = clavesNormalizadas.indexOf(pueblo);
          return index >= 0 && Object.values(bloqueos)[index] === "NO";
        }
      ]
    });
    calendarioIniciado = true;
  }

  document.getElementById("pueblo").addEventListener("input", () => {
    const pueblo = document.getElementById("pueblo").value;
    const aviso = document.getElementById("avisoPueblo");
    aviso.style.display = pueblo === "La Cabrera" ? "block" : "none";
    aviso.textContent = "Los pedidos para La Cabrera solo se entregan lunes y jueves.";
    inicializarCalendario();
  });

  document.getElementById("fecha").addEventListener("change", () => {
    const fechaStr = document.getElementById("fecha").value;
    const pueblo = limpiarTexto(document.getElementById("pueblo").value);
    const aviso = document.getElementById("avisoFecha");
    const bloqueos = fechasNoDisponibles[fechaStr];

    if (bloqueos) {
      const clavesNormalizadas = Object.keys(bloqueos).map(k => limpiarTexto(k));
      const index = clavesNormalizadas.indexOf(pueblo);
      if (index >= 0 && Object.values(bloqueos)[index] === "NO") {
        aviso.style.display = "block";
        aviso.textContent = "Lo sentimos, no hay reparto disponible en esa fecha. Por favor, elige otro día.";
        return;
      }
    }
    aviso.style.display = "none";
  });

  document.getElementById("pedidoForm").addEventListener("submit", e => {
    const fechaStr = document.getElementById("fecha").value;
    const pueblo = limpiarTexto(document.getElementById("pueblo").value);
    const aviso = document.getElementById("avisoFecha");
    const bloqueos = fechasNoDisponibles[fechaStr];

    if (bloqueos) {
      const clavesNormalizadas = Object.keys(bloqueos).map(k => limpiarTexto(k));
      const index = clavesNormalizadas.indexOf(pueblo);
      if (index >= 0 && Object.values(bloqueos)[index] === "NO") {
        e.preventDefault();
        aviso.style.display = "block";
        aviso.textContent = "Lo sentimos, no hay reparto disponible en esa fecha. Por favor, elige otro día.";
        return;
      }
    }

    e.preventDefault();

    const datos = {
      fecha: fechaStr,
      zona: document.getElementById("zona").value,
      pueblo: document.getElementById("pueblo").value,
      direccion: document.getElementById("direccion").value,
      cantidad: document.getElementById("cantidad").value,
      nombre: document.getElementById("nombre").value,
      telefono: document.getElementById("telefono").value,
      email: document.getElementById("email").value,
      observaciones: document.getElementById("observaciones").value,
      consentimiento: document.getElementById("consentimiento").checked ? "Sí" : "No"
    };

    const formData = new FormData();
    for (const key in datos) {
      formData.append(key, datos[key]);
    }

    fetch("https://script.google.com/macros/s/AKfycbxhTezL0HmZyd13o73LgqGdSksZowg34n1_ZNtuLAaEU4qTB3QPskM6HCTdesg6gZmDxw/exec", {
      method: "POST",
      mode: "no-cors",
      body: formData
    });

    document.getElementById("pedidoForm").style.display = "none";
    document.getElementById("mensaje").style.display = "block";
  });
</script>
</body>
</html>
